<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.rest.sadeductpay.dao.SaDeductPayDao">

    <select id="getSaDeductPayByCdEmp" parameterType="java.util.Map" resultType="SaDeductPay">
        SELECT p.CD_DEDUCT ,d.NM_DEDUCT , p.ALLOW_PAY , p.CD_EMP ,d2."DATE" AS "PAYMENT_DATE" , d2.ALLOW_YEAR , d2."MONTH" AS "ALLOW_MONTH"
            FROM SADEDUCTPAY p LEFT OUTER JOIN SADEDUCT d
                ON p.CD_DEDUCT = d.CD_DEDUCT LEFT OUTER JOIN "DATE" d2
                ON d2."DATE_ID" = p.DATE_ID
        WHERE p.CD_EMP = #{cdEmp}
            AND  d2.DATE_ID = #{dateId}
        <if test="cdDeduct                    != null"> AND s.CD_DEDUCT = #{cdDeduct} </if>
    </select>

    <update id="updateSaDeductPay" parameterType="java.util.Map">
        UPDATE SADEDUCTPAY
            set ALLOW_PAY = #{allowPay}
        WHERE CD_EMP = #{cdEmp}
            AND DATE_ID = #{dateId}
            AND CD_DEDUCT = #{cdDeduct}
    </update>

    <!-- 합계 데이터 조회-->
    <select id="getSalDeductPaySum"  parameterType="java.util.Map" resultType="map">
        SELECT
            p.CD_DEDUCT AS "cdDeduct"
            , (SELECT s.NM_DEDUCT FROM SADEDUCT s WHERE s.CD_DEDUCT = p.CD_DEDUCT) AS "nmDeduct"
            , TO_CHAR(sum(p.ALLOW_PAY)) AS "sumDeductPay"
        FROM SADEDUCTPAY p LEFT OUTER JOIN SADEDUCT d
            ON p.CD_DEDUCT = d.CD_DEDUCT LEFT OUTER JOIN "DATE" d
            ON p.DATE_ID = d.DATE_ID LEFT OUTER JOIN EMP e
            ON e.CD_EMP = p.CD_EMP
            <if test="paymentDateFlag   != null and paymentDateFlag    != ''">
                AND D."DATE" = (SELECT "DATE" FROM "DATE" WHERE date_id = #{dateId})
                <if test="nowFlag       != null and nowFlag     != ''">
                    AND e.DA_RETIRE &lt; (SELECT "DATE" FROM "DATE" WHERE date_id = #{dateId})
                </if>
            </if>
            <if test="allowMonthFlag    != null and allowMonthFlag     != ''">
                AND d."MONTH" = (SELECT "MONTH" FROM "DATE" WHERE date_id = #{dateId})
                <if test="nowFlag       != null and nowFlag     != ''">
                    AND TO_DATE(e.DA_RETIRE, 'YYYY-MM-DD') &lt; TO_DATE((SELECT "MONTH" FROM "DATE" WHERE date_id = #{dateId}), 'YYYY-MM')
                </if>
            </if>
            <if test="allowYearFlag     != null and allowYearFlag      != ''">
                AND d.ALLOW_YEAR = (SELECT "ALLOW_YEAR" FROM "DATE" WHERE date_id = #{dateId})
                <if test="nowFlag       != null and nowFlag     != ''">
                    AND TO_DATE(e.DA_RETIRE, 'YYYY') &lt; TO_DATE((SELECT "ALLOW_YEAR" FROM "DATE" WHERE date_id = #{dateId}), 'YYYY')
                </if>
            </if>
        GROUP BY p.CD_DEDUCT
    </select>
</mapper>