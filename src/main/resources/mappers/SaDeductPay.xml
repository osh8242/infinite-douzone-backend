<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.rest.sadeductpay.dao.SaDeductPayDao">

    <select id="getSaDeductPayByCdEmp" parameterType="SaDeductPay" resultType="SaDeductPay">
        SELECT d.CD_DEDUCT,d.NM_DEDUCT, p.*
        FROM SADEDUCT d LEFT OUTER JOIN
        (
            SELECT CD_DEDUCT
            , (SELECT NM_DEDUCT FROM SADEDUCT d WHERE d.CD_DEDUCT = s.CD_DEDUCT) as NM_DEDUCT
            , ALLOW_PAY
            , CD_EMP
            , ALLOW_MONTH
            , ALLOW_YEAR
            , PAYMENT_DATE
            FROM SADEDUCTPAY s
            WHERE CD_EMP = #{cdEmp}
            AND ALLOW_MONTH = #{allowMonth}
            <if test="cdDeduct                         != null"> AND CD_DEDUCT = #{cdDeduct} </if>
        ) p
        ON d.CD_DEDUCT = p.CD_DEDUCT
        ORDER BY d.NM_DEDUCT asc
    </select>

    <update id="updateSaDeductPay" parameterType="java.util.Map">
        UPDATE SADEDUCTPAY
            set ALLOW_PAY = #{allowPay}
        WHERE CD_EMP = #{cdEmp}
            AND ALLOW_MONTH = #{allowMonth}
            AND CD_DEDUCT = #{cdDeduct}
    </update>

    <!-- 합계 데이터 조회-->
    <select id="getSalDeductPaySum"  parameterType="SaDeductPay" resultType="SaDeductPay">
        SELECT d.CD_DEDUCT,d.NM_DEDUCT, p.*
        FROM SADEDUCT d LEFT OUTER JOIN
        (
            SELECT
                s.CD_DEDUCT
                , (SELECT NM_DEDUCT FROM SADEDUCT s2 WHERE s2.CD_DEDUCT=s.CD_DEDUCT) AS NM_DEDUCT
                , sum(s.ALLOW_PAY) AS SUM_DEDUCT_PAY
            FROM
                SADEDUCTPAY s
            WHERE 1=1
                <if test="cdEmp                         != null"> AND s.CD_EMP  = #{cdEmp} </if>
                <if test="allowMonth                    != null"> AND s.ALLOW_MONTH  = #{allowMonth} </if>
                <if test="allowYear                     != null"> AND s.ALLOW_YEAR  = #{allowYear} </if>
            GROUP BY s.CD_DEDUCT
        ) p
        ON d.CD_DEDUCT = p.CD_DEDUCT
        ORDER BY d.NM_DEDUCT asc
    </select>
</mapper>