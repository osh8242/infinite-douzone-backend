<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.rest.sadeductpay.dao.SaDeductPayDao">

    <select id="getSaDeductPayByCdEmp" parameterType="SaDeductPay" resultType="SaDeductPay">
        SELECT p.CD_DEDUCT ,d.NM_DEDUCT , p.ALLOW_PAY , p.CD_EMP ,p.PAYMENT_DATE , d2."YEAR" AS "ALLOW_YEAR" , d2."MONTH" AS "ALLOW_MONTH"
            FROM SADEDUCTPAY p LEFT OUTER JOIN SADEDUCT d
                ON p.CD_DEDUCT = d.CD_DEDUCT LEFT OUTER JOIN "DATE" d2
                ON d2."DATE" = p.PAYMENT_DATE
        WHERE p.CD_EMP = #{cdEmp}
            AND  p.PAYMENT_DATE = #{paymentDate}
        <if test="cdDeduct                    != null"> AND s.CD_DEDUCT = #{cdDeduct} </if>
    </select>

    <update id="updateSaDeductPay" parameterType="java.util.Map">
        UPDATE SADEDUCTPAY
            set ALLOW_PAY = #{allowPay}
        WHERE CD_EMP = #{cdEmp}
            AND PAYMENT_DATE = #{paymentDate}
            AND CD_DEDUCT = #{cdDeduct}
    </update>

    <!-- 합계 데이터 조회-->
    <select id="getSalDeductPaySum"  parameterType="SaDeductPay" resultType="SaDeductPay">
        SELECT p.CD_DEDUCT
        , (SELECT NM_DEDUCT FROM SADEDUCT d WHERE d.CD_DEDUCT=p.CD_DEDUCT) AS NM_DEDUCT
        , sum(p.ALLOW_PAY) AS SUM_DEDUCT_PAY
            FROM SADEDUCTPAY p LEFT OUTER JOIN SADEDUCT d
                ON p.CD_DEDUCT = d.CD_DEDUCT
        WHERE 1=1
        <if test="cdEmp                         != null"> AND p.CD_EMP  = #{cdEmp} </if>
        <if test="paymentDate                   != null"> AND p.PAYMENT_DATE  = #{paymentDate} </if>
            GROUP BY p.CD_DEDUCT
    </select>
</mapper>