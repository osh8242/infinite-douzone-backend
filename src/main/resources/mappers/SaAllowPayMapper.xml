<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.rest.saallowpay.dao.SaAllowPayMapper">

    <!-- 급여리스트 -->
    <select id="getSalAlLowPayListByEmp" parameterType="java.util.Map" resultType="SaAllowPay">
        SELECT
            s.CD_ALLOW, s.SAL_DIVISION, s.NM_ALLOW, s.YN_TAX, p.ALLOW_PAY
        FROM
            SAALLOW s LEFT OUTER JOIN (
                SELECT CD_ALLOW,ALLOW_PAY FROM SAALLOWPAY
                WHERE CD_EMP = #{cdEmp}
                AND DATE_ID = #{dateId}
            ) p
            ON s.CD_ALLOW = p.CD_ALLOW
        WHERE (s.SAL_DIVISION = 'SAL' OR p.ALLOW_PAY IS NOT NULL)
    </select>

    <!-- 급여자료 입력 -->
    <insert id="insertSalAllowPay" parameterType="SaAllowPay">
        INSERT INTO SAALLOWPAY(
          CD_ALLOW , ALLOW_PAY , CD_EMP  , DATE_ID)
        VALUES (
            #{cdAllow}
            , #{allowPay}
            , #{cdEmp}
            , #{dateId}
        )
    </insert>

    <!-- 급여자료 수정 -->
    <update id="updateSalAllowPay" parameterType="java.util.Map">
        UPDATE SAALLOWPAY
            SET ALLOW_PAY = #{allowPay}
        WHERE CD_EMP = #{cdEmp}
            AND CD_ALLOW = #{cdAllow}
            AND DATE_ID = #{dateId}
    </update>

    <!-- 합계 데이터 조회-->
    <select id="getSalAllowPaySum" parameterType="java.util.Map" resultType="map">
        SELECT
            p.CD_ALLOW AS "cdAllow"
            , (SELECT s.NM_ALLOW FROM SAALLOW s WHERE s.CD_ALLOW = p.CD_ALLOW) AS "nmAllow"
            , a.YN_TAX AS "ynTax"
            , TO_CHAR(sum(p.ALLOW_PAY)) AS "sumAllowPay"
        FROM SAALLOWPAY p LEFT OUTER JOIN SAALLOW a
            ON a.CD_ALLOW  = p.CD_ALLOW LEFT OUTER JOIN EMP e
            ON e.CD_EMP = p.CD_EMP LEFT OUTER JOIN "DATE" d
            ON p.DATE_ID = d.DATE_ID
            <if test="paymentDateFlag   != null and paymentDateFlag    != ''">
                AND D."DATE" = (SELECT "DATE" FROM "DATE" WHERE date_id = #{dateId})
                <if test="nowFlag       != null and nowFlag     != ''">
                    AND e.DA_RETIRE &lt; (SELECT "DATE" FROM "DATE" WHERE date_id = #{dateId})
                </if>
            </if>
            <if test="allowMonthFlag    != null and allowMonthFlag     != ''">
                AND d."MONTH" = (SELECT "MONTH" FROM "DATE" WHERE date_id = #{dateId})
                <if test="nowFlag       != null and nowFlag     != ''">
                    AND TO_DATE(e.DA_RETIRE, 'YYYY-MM-DD') &lt; TO_DATE((SELECT "MONTH" FROM "DATE" WHERE date_id = #{dateId}), 'YYYY-MM')
                </if>
            </if>
            <if test="allowYearFlag     != null and allowYearFlag      != ''">
                AND d.ALLOW_YEAR = (SELECT "ALLOW_YEAR" FROM "DATE" WHERE date_id = #{dateId})
                <if test="nowFlag       != null and nowFlag     != ''">
                    AND TO_DATE(e.DA_RETIRE, 'YYYY') &lt; TO_DATE((SELECT "ALLOW_YEAR" FROM "DATE" WHERE date_id = #{dateId}), 'YYYY')
                </if>
            </if>
        GROUP BY p.CD_ALLOW, a.YN_TAX
    </select>


    <!-- 급여자료 입력-->
<!--    <insert id="insertSalAllowPay" parameterType="SaAllowPay">-->
<!--        <selectKey keyProperty="dateId" resultType="String" order="BEFORE">-->
<!--            SELECT DATE_ID-->
<!--            FROM "DATE"-->
<!--            WHERE allow_year = #{allowYear}-->
<!--            AND "MONTH" = #{allowMonth}-->
<!--            AND "DATE" = #{paymentDate}-->
<!--        </selectKey>-->
<!--        <if test="dateId == null">-->
<!--            <insert id="insertDate" parameterType="SaAllowPay">-->
<!--                INSERT INTO "DATE" (allow_year, "MONTH", "DATE", DATE_ID)-->
<!--                VALUES (-->
<!--                    #{allowYear}-->
<!--                    , #{allowMonth}-->
<!--                    , #{paymentDate}-->
<!--                    , #{allowYear}#{allowMonth}#{paymentDate}-->
<!--                )-->
<!--                <selectKey keyProperty="dateId" resultType="String" order="AFTER">-->
<!--                    RETURNING DATE_ID INTO #{dateId}-->
<!--                </selectKey>-->
<!--            </insert>-->
<!--        </if>-->
<!--        INSERT INTO SAALLOWPAY(-->
<!--            CD_ALLOW-->
<!--            , ALLOW_PAY-->
<!--            , CD_EMP-->
<!--            , DATE_ID-->
<!--        ) VALUES (-->
<!--            #{cdAllow}-->
<!--            , #{allowPay}-->
<!--            , #{cdEmp}-->
<!--            , #{dateId}-->
<!--        )-->
<!--    </insert>-->

    <!--지급일 리스트(코드도움창) -->
    <select id="getPaymentDateList" parameterType="java.util.Map" resultType="hashmap">
        SELECT "DATE" AS "paymentDate" ,  DATE_ID AS "dateId"
            FROM "DATE" d
        WHERE d.ALLOW_YEAR = #{allowYear}
            AND d."MONTH" = #{allowMonth}
    </select>

    <!-- 모달_급여항목등록 급여항목 리스트 -->
    <select id="getsalAllowList" parameterType="java.util.Map" resultType="hashmap">
        SELECT
            CD_ALLOW AS "cdAllow",
            NM_ALLOW AS "nmAllow",
            YN_TAX AS "ynTax",
            SAL_DIVISION AS "salDivison",
            c.CODE_NAME AS "nmSalDivison",
            COMMONLY_YN as "commonlyYn",
            MONTHLY_YN as "monthlyYn"
        FROM SAALLOW a LEFT OUTER JOIN CODE c
            ON c.CODE_ID = a.SAL_DIVISION
        ORDER BY COMMONLY_YN
    </select>

    <!-- 모달_비과세 항목 설정 리스트 -->
    <select id="getNonTaxSalAllowList" parameterType="java.util.Map" resultType="hashmap">
        SELECT
            CD_ALLOW as "cdAllow",
            NM_ALLOW as "nmAllow",
            NONTAX_LIMIT as "nonTaxLimit",
            NONTAX_DIVISON as "nonTaxDivison"
        FROM SAALLOW s
        WHERE s.YN_TAX ='N'
    </select>

</mapper>